<!doctype html>
<html lang="es">
<head>
<meta charset="utf-8" />
<title>Le√≥n GTO ¬∑ DENUE ‚Äî Ultra</title>
<meta name="viewport" content="width=device-width, initial-scale=1" />
<link href="https://cdn.jsdelivr.net/npm/maplibre-gl@5.6.2/dist/maplibre-gl.css" rel="stylesheet">
<link rel="stylesheet" href="css/styles.css">
<script src="https://cdn.jsdelivr.net/npm/maplibre-gl@5.6.2/dist/maplibre-gl.min.js"></script>

<script>
  // Algunas libs esperan window.mapboxglssss
  window.mapboxgl = window.maplibregl;
</script>

<!-- PMTiles (vector tiles) -->
<script type="module">
  import * as pmtiles from 'https://cdn.jsdelivr.net/npm/pmtiles@3.0.6/dist/index.js';
  const protocol = new pmtiles.Protocol();
  maplibregl.addProtocol('pmtiles', protocol.tile);
  window.__pmtilesReady = true;
  // Exportar para uso posterior
  window.pmtiles = pmtiles;
</script>

<!-- Turf (geo utilidades) -->
<script src="https://cdn.jsdelivr.net/npm/@turf/turf@7.1.0/turf.min.js"></script>

<!-- Chart.js para gr√°ficos -->
<script src="libs/chart-simple.js"></script>
<script>
  // Verificar que Chart.js est√© disponible
  console.log('‚úÖ Chart.js Simple cargado:', typeof Chart !== 'undefined' ? 'OK' : 'FAIL');
  
  // Intentar cargar Chart.js real como mejora opcional
  const realChartScript = document.createElement('script');
  realChartScript.src = 'https://cdn.jsdelivr.net/npm/chart.js@4.4.0/dist/chart.min.js';
  realChartScript.onload = () => {
    console.log('‚úÖ Chart.js real cargado como mejora');
  };
  realChartScript.onerror = () => {
    console.log('üìä Usando Chart.js simple (CDN no disponible)');
  };
  document.head.appendChild(realChartScript);
</script>

<!-- Nuestros m√≥dulos -->
<script src="js/config.js"></script>
<script src="js/utils.js"></script>
<script src="js/data.js"></script>
<script src="js/data-loader.js"></script>
<script src="js/drawing.js"></script>
<script src="js/analytics.js"></script>
<script src="js/data-explorer.js"></script>
<script src="js/main.js"></script>
</head>
<body>
  <div id="map"></div>

  <!-- Panel izquierdo -->
      <div id="panel" class="panel"></div>
    <button id="btnShow" class="fab">üéõÔ∏è Filtros</button>

    <!-- Panel derecho (detalle + guardados) -->
    <aside id="info" class="info"></aside>

    <!-- MODAL DE RESUMEN DE REGI√ìN -->
    <div id="modalResumen" class="modal-overlay"></div>

    <!-- PANEL DE ANALYTICS -->
    <div id="analyticsPanel" class="analytics-panel"></div>

<script>
  (async () => {
    await Promise.all([
      loadPartial('partials/panel.html', '#panel'),
      loadPartial('partials/info.html', '#info'),
      loadPartial('partials/modal-resumen.html', '#modalResumen'),
      loadPartial('partials/analytics.html', '#analyticsPanel')
    ]);


  // ===== INICIALIZACI√ìN =====
  const map = new maplibregl.Map({ 
    container: 'map', 
    style: BASEMAPS.OSM, 
    center: CONFIG.DEFAULT_CENTER, 
    zoom: CONFIG.DEFAULT_ZOOM 
  });
  map.addControl(new maplibregl.NavigationControl(), 'top-right');

  // ===== REFERENCIAS DOM =====
  const panel = document.getElementById('panel');
  const btnHide = document.getElementById('btnHide');
  const btnShow = document.getElementById('btnShow');
  const filesSel = document.getElementById('files');
  const btnRefresh = document.getElementById('refresh');
  const btnLoad = document.getElementById('load');
  const btnFit = document.getElementById('fit');
  const baseSel = document.getElementById('basemap');
  const statusEl = document.getElementById('status');
  const tglHeat = document.getElementById('tglHeat');
  const viewMode = document.getElementById('viewMode');
  const modeBadge = document.getElementById('modeBadge');
  const clipCount = document.getElementById('clipCount');

  // Referencias adicionales
  const nameSearch = document.getElementById('nameSearch');
  const btnClearName = document.getElementById('btnClearName');
  const classSearch = document.getElementById('classSearch');
  const classSel = document.getElementById('classSel');
  const btnApply = document.getElementById('applyFilter');
  const btnClear = document.getElementById('clearFilter');
  const btnExport = document.getElementById('export');
  const classStatsEl = document.getElementById('classStats');
  
  const info = document.getElementById('info');
  const detail = document.getElementById('detail');
  const savedList = document.getElementById('savedList');
  const exportSavedBtn = document.getElementById('exportSaved');
  const importSavedInp = document.getElementById('importSaved');
  const clearSavedBtn = document.getElementById('clearSaved');

  // ===== SISTEMAS =====
  const drawingSystem = new DrawingSystem(map, statusEl, clipCount);
  const analytics = new Analytics();
  
  // Hacer analytics disponible globalmente
  window.analytics = analytics;

  // ===== MODAL DE RESUMEN =====
  const modalResumen = document.getElementById('modalResumen');
  const closeModal = document.getElementById('closeModal');
  
  // Cerrar modal
  closeModal.onclick = () => modalResumen.classList.remove('show');
  modalResumen.onclick = (e) => {
    if (e.target === modalResumen) modalResumen.classList.remove('show');
  };
  
  // Cerrar con Escape
  window.addEventListener('keydown', (e) => {
    if (e.key === 'Escape' && modalResumen.classList.contains('show')) {
      modalResumen.classList.remove('show');
    }
  });
  
  function mostrarResumenRegion(totalFiltrados, totalGeneral, clasesMap) {
    // Actualizar n√∫meros principales
    document.getElementById('totalNegocios').textContent = totalFiltrados.toLocaleString();
    document.getElementById('totalGeneral').textContent = totalGeneral.toLocaleString();
    
    // Convertir Map a array ordenado
    const clasesArray = Array.from(clasesMap.entries())
      .sort((a, b) => b[1] - a[1]); // Ordenar por cantidad (mayor a menor)
    
    document.getElementById('tiposCount').textContent = clasesArray.length;
    
    // Generar lista de negocios
    const negociosLista = document.getElementById('negociosLista');
    negociosLista.innerHTML = clasesArray.map(([clase, cantidad]) => `
      <div class="negocio-item">
        <div class="negocio-nombre">${clase}</div>
        <div class="negocio-cantidad">${cantidad.toLocaleString()}</div>
      </div>
    `).join('');
    
    // Mostrar modal
    modalResumen.classList.add('show');
  }

  // Hacer funci√≥n disponible globalmente
  window.mostrarResumenRegion = mostrarResumenRegion;

  // ===== PANEL DE ANALYTICS =====
  const analyticsPanel = document.getElementById('analyticsPanel');
  const btnAnalytics = document.getElementById('btnAnalytics');
  const btnExploreData = document.getElementById('btnExploreData');
  const closeAnalytics = document.getElementById('closeAnalytics');
  const exportAnalytics = document.getElementById('exportAnalytics');
  
  // Abrir panel de analytics
  btnAnalytics.onclick = () => {
    if (window.__MODE === 'geojson' && window.__fullGJ) {
      analytics.initialize(window.__fullGJ);
      analyticsPanel.classList.add('show');
    } else {
      alert('‚ö†Ô∏è Carga un dataset GeoJSON primero para ver analytics');
    }
  };
  
  // Explorar estructura de datos (temporal para desarrollo)
  btnExploreData.onclick = () => {
    if (window.__MODE === 'geojson' && window.__fullGJ) {
      const results = window.exploreData();
      console.log('üìã Resumen ejecutivo:', results);
      alert(`üîç Exploraci√≥n completa!\n\nüìä ${results.totalRecords.toLocaleString()} registros\nüèòÔ∏è ${results.uniqueCounts.colonias} colonias √∫nicas\nüìà ${results.uniqueCounts.clases} tipos de negocio\n\nRevisa la consola para detalles completos`);
    } else {
      alert('‚ö†Ô∏è Carga un dataset GeoJSON primero');
    }
  };
  
  // Cerrar panel
  closeAnalytics.onclick = () => analyticsPanel.classList.remove('show');
  
  // Exportar analytics
  exportAnalytics.onclick = () => {
    if (analytics.data) {
      analytics.exportAnalytics();
    } else {
      alert('‚ö†Ô∏è No hay datos para exportar');
    }
  };

  // ===== EVENTOS B√ÅSICOS =====
  // Panel toggle
  if (localStorage.getItem(CONFIG.PANEL_KEY) === '1') panel.classList.add('hidden');
  btnHide.onclick = () => { panel.classList.add('hidden'); localStorage.setItem(CONFIG.PANEL_KEY, '1'); };
  btnShow.onclick = () => { panel.classList.remove('hidden'); localStorage.setItem(CONFIG.PANEL_KEY, '0'); };

  // Cambio de mapa base
  baseSel.onchange = () => {
    map.setStyle(baseSel.value === 'carto' ? BASEMAPS.CARTO : BASEMAPS.OSM);
    map.once('styledata', () => { 
      if (window.__MODE === 'geojson' && window.__currentGJ) ensureLayersAndSetData(window.__currentGJ);
      if (window.__MODE === 'pmtiles' && window.__pmSrc) ensurePMTilesLayers(window.__pmSrc, window.__pmLayer);
    });
  };

  // Botones de dibujo
  document.getElementById('drawPoly').onclick = () => drawingSystem.startDrawing();
  document.getElementById('clearPoly').onclick = () => drawingSystem.clearRegion();
  document.getElementById('exportClip').onclick = () => { 
    if (window.__MODE === 'geojson' && window.__currentGJ) exportFiltered(); 
  };

  // Botones principales
  btnRefresh.onclick = listFiles;
  btnLoad.onclick = loadSelected;
  btnFit.onclick = () => { 
    if (window.__MODE === 'geojson' && window.__currentGJ) Utils.fitToData(map, window.__currentGJ); 
  };

  // Atajos de teclado
  window.addEventListener('keydown', (e) => {
    if (e.key === 'f' || e.key === 'F') { 
      panel.classList.toggle('hidden'); 
      localStorage.setItem(CONFIG.PANEL_KEY, panel.classList.contains('hidden') ? '1' : '0'); 
    }
    if (e.key === 'i' || e.key === 'I') info.scrollIntoView({behavior: 'smooth'});
    if (e.key === 'h' || e.key === 'H') { 
      const modes = ['points', 'clusters', 'heat'];
      const current = viewMode.value;
      const next = modes[(modes.indexOf(current) + 1) % modes.length];
      viewMode.value = next;
      toggleVisualization();
    }
    if (e.key === 'c' || e.key === 'C') { 
      if (window.__MODE === 'geojson' && window.__currentGJ) Utils.fitToData(map, window.__currentGJ); 
    }
    if (e.key === 'a' || e.key === 'A') {
      if (window.__MODE === 'geojson' && window.__fullGJ) {
        analytics.initialize(window.__fullGJ);
        analyticsPanel.classList.add('show');
      }
    }
    if (e.key === '/') { nameSearch.focus(); e.preventDefault(); }
    if (e.key === 'Enter' && document.activeElement === nameSearch) applyFilter();
  });

  // ===== FUNCIONES PRINCIPALES SIMPLIFICADAS =====
  
  // Listado de archivos
  async function listFiles() {
    statusEl.textContent = 'Buscando archivos‚Ä¶';
    const data = await fetch('/api/data/list').then(r => r.json()).catch(() => null);
    filesSel.innerHTML = '';
    
    if (!data || !data.ok || data.count === 0) {
      filesSel.innerHTML = '<option>(no hay archivos)</option>';
      statusEl.textContent = 'Coloca .geojson/.json/.pmtiles en /data';
      return;
    }
    
    for (const it of data.items) {
      const dt = new Date(it.mtimeMs).toLocaleString();
      const opt = document.createElement('option');
      opt.value = it.name;
      opt.textContent = `${it.name} ‚Äî ${(it.size/1024).toFixed(1)} KB ‚Äî ${dt}`;
      filesSel.appendChild(opt);
    }
    
    // Preferir autom√°ticamente el .geojson m√°s nuevo (m√°s peque√±o para producci√≥n)
    const opts = Array.from(filesSel.options);
    const preferred = opts.find(o => o.value.toLowerCase().endsWith('.geojson')) || opts[0];
    if (preferred) filesSel.value = preferred.value;

    statusEl.textContent = `Encontrados ${data.count} archivos. Seleccionado: ${filesSel.value}`;
  }

  // Cargar archivo seleccionado
  async function loadSelected() {
    const name = filesSel.value; 
    if (!name || name.startsWith('(')) { 
      statusEl.textContent = 'Selecciona un archivo de la lista.'; 
      return; 
    }
    if (name.toLowerCase().endsWith('.pmtiles')) { 
      await loadPMTiles(name); 
      return; 
    }
    await loadGeoJSON(name);
  }

  // Cargar GeoJSON con DataLoader optimizado
  async function loadGeoJSON(name) {
    window.__MODE = 'geojson';
    modeBadge.textContent = 'Modo: GeoJSON';
    statusEl.textContent = `Cargando ${name}‚Ä¶ (optimizado para producci√≥n)`;
    
    try {
      // Usar DataLoader inteligente
      const fullGJ = await window.dataLoader.loadData(name);
      
      if (!fullGJ) {
        statusEl.textContent = 'No pude cargar los datos. Int√©ntalo de nuevo.';
        return;
      }

      window.__fullGJ = fullGJ;
      window.__currentGJ = fullGJ;
      window.__region = null;

      const stats = DataProcessor.buildClassStats(fullGJ);
      window.__classList = stats.list;
      populateClassSelect(stats.list, classSearch.value || '');
      classStatsEl.textContent = `Clases √∫nicas: ${stats.list.length} ‚Ä¢ Puntos totales: ${stats.total.toLocaleString()}`;

      ensureLayersAndSetData(fullGJ);
      Utils.fitToData(map, fullGJ);
      statusEl.textContent = `Cargado: ${(fullGJ.features?.length ?? 0).toLocaleString()} puntos (${name}).`;
      clearInfo();
      
      // üöÄ SIEMPRE inicializar analytics con los datos frescos
      if (window.analytics) {
        analytics.initialize(fullGJ);
      }
      
    } catch (error) {
      console.error('‚ùå Error en loadGeoJSON:', error);
      statusEl.textContent = `Error al cargar ${name}: ${error.message}`;
    }
  }

  // Cargar PMTiles
  async function loadPMTiles(name) {
    const ok = await Utils.waitForPMTiles(CONFIG.PMTILES_TIMEOUT);
    window.__MODE = 'pmtiles';
    modeBadge.textContent = 'Modo: PMTiles (r√°pido)';
    
    if (!ok) { 
      statusEl.textContent = 'PMTiles a√∫n no est√° listo. Recarga y prueba de nuevo.'; 
      return; 
    }

    statusEl.textContent = `Cargando PMTiles ${name}‚Ä¶`;
    const httpUrl = window.location.origin + '/data/' + encodeURIComponent(name);
    const layerName = 'denue'; // Nombre fijo
    window.__pmSrc = httpUrl;
    window.__pmLayer = layerName;

    ensurePMTilesLayers(httpUrl, layerName);
    statusEl.textContent = `PMTiles listo (capa: ${layerName}).`;
    clearInfo();
  }

  // ===== Filtros (solo GeoJSON)
  classSearch.addEventListener('input', ()=>populateClassSelect(window.__classList||[], classSearch.value||''));
  btnClear.onclick=()=>{ 
    // Si est√° dibujando, cancelar primero
    if (drawingSystem.isDrawing) {
      drawingSystem.cancelDrawing();
      return;
    }
    
    for(const o of classSel.options) o.selected=false; 
    classSearch.value=''; 
    nameSearch.value=''; 
    window.__region=null; 
    clipCount.textContent='‚Äî';
    
    // üßπ Limpiar filtro de analytics tambi√©n
    if (window.analytics) {
      window.analytics.currentFilter = null;
    }
    
    // Limpiar pol√≠gono visual
    if (map.getSource('draw-polygon')) {
      map.getSource('draw-polygon').setData({ type: 'FeatureCollection', features: [] });
    }
    
    // üöÄ FORZAR REGRESO A DATOS COMPLETOS
    window.__currentGJ = window.__fullGJ;
    
    applyFilter(); 
    
    // üéØ Actualizar analytics si est√° abierto
    if (analyticsPanel.classList.contains('show') && window.analytics && window.__fullGJ) {
      // üßπ Solo limpiar filtro si realmente se est√° limpiando todo
      window.analytics.currentFilter = null;
      window.analytics.initialize(window.__fullGJ);
    }
  };
  btnApply.onclick=applyFilter; btnExport.onclick=exportFiltered;
  btnClearName.onclick=()=>{ nameSearch.value=''; applyFilter(); };

  function applyFilter() {
    console.log('üîç applyFilter iniciado:', { mode: window.__MODE, hasData: !!window.__fullGJ, hasRegion: !!window.__region });
    
    if (window.__MODE !== 'geojson' || !window.__fullGJ) return;
    
    const selected = Array.from(classSel.selectedOptions).map(o => o.value);
    const needle = (nameSearch.value || '').trim().toLowerCase();
    const sel = new Set(selected);

    const region = window.__region; // GeoJSON Polygon|MultiPolygon o null
    console.log('üéØ Filtrando con regi√≥n:', region);
    
    const feats = window.__fullGJ.features.filter(f => {
      const n = (f.properties?.__N?.Nombre || '').toLowerCase();
      const c = (f.properties?.__N?.Clase || '').trim() || '(sin clase)';
      const byName = !needle || n.includes(needle);
      const byClass = !selected.length || sel.has(c);
      if (!(byName && byClass)) return false;
      if (!region) return true;
      const pt = turf.point(f.geometry.coordinates);
      return turf.booleanPointInPolygon(pt, region);
    });

    console.log('üìä Puntos filtrados:', feats.length, 'de', window.__fullGJ.features.length);
    
    const gj = { type: 'FeatureCollection', features: feats };
    window.__currentGJ = gj;
    ensureLayersAndSetData(gj);
    Utils.fitToData(map, gj);
    
    // üî• ACTUALIZAR ANALYTICS cuando cambian los filtros
    if (analyticsPanel.classList.contains('show') && window.analytics) {
      console.log('üîÑ Actualizando analytics con datos filtrados');
      // üöÄ PRESERVAR el filtro activo antes de actualizar
      const currentFilter = window.analytics.currentFilter;
      window.analytics.initialize(gj);
      // üöÄ RESTAURAR el filtro despu√©s de inicializar
      window.analytics.currentFilter = currentFilter;
      console.log('üîÑ Filtro preservado:', currentFilter);
    }
    
    // Mensaje m√°s informativo
    const baseMsg = `Filtrado: ${feats.length.toLocaleString()} de ${window.__fullGJ.features.length.toLocaleString()} puntos`;
    let extraInfo = '';
    
    if (region) {
      // An√°lisis de lo que hay en la regi√≥n
      const classes = new Map();
      feats.forEach(f => {
        const clase = f.properties?.__N?.Clase || '(sin clase)';
        classes.set(clase, (classes.get(clase) || 0) + 1);
      });
      
      const topClasses = Array.from(classes.entries())
        .sort((a, b) => b[1] - a[1])
        .slice(0, 3)
        .map(([k, v]) => `${k} (${v})`)
        .join(', ');
        
      extraInfo = ` | üéØ En regi√≥n: ${topClasses}`;
      clipCount.textContent = `${feats.length.toLocaleString()} pts en regi√≥n`;
      console.log('üìà Top clases en regi√≥n:', topClasses);
    } else {
      clipCount.textContent = '‚Äî';
    }
    
    statusEl.textContent = baseMsg + extraInfo;
    clearInfo();
  }

  // Hacer applyFilter disponible globalmente
  window.applyFilter = applyFilter;

  function exportFiltered(){
    if(window.__MODE!=='geojson' || !window.__currentGJ) return;
    const gj=window.__currentGJ;
    const name=`leon_filtrado_${new Date().toISOString().replace(/[:.]/g,'-')}`;
    const ok = confirm('OK = GeoJSON | Cancel = CSV');
    if(ok) Utils.downloadJSON(gj, name+'.geojson'); else Utils.downloadCSV(gj, name+'.csv');
  }

  // ===== Capas GEOJSON + clicks
  function ensureLayersAndSetData(gj){
    try{
      if(!map.getSource('poi')){
        // Fuente SIN clustering para puntos individuales
        map.addSource('poiPoints',{ type:'geojson', data:gj });
        map.addLayer({ id:'individual-points', type:'circle', source:'poiPoints',
          paint:{ 
            'circle-radius':['interpolate',['linear'],['zoom'], 6,2, 12,4, 16,8],
            'circle-color':'#2563eb', 
            'circle-opacity':0.85, 
            'circle-stroke-color':'#fff', 
            'circle-stroke-width':0.5 
          }
        });

        // Fuente CON clustering para modo clusters  
        map.addSource('poi',{ type:'geojson', data:gj, cluster:true, clusterRadius:40, clusterMaxZoom:14 });
        map.addLayer({ id:'clusters', type:'circle', source:'poi', filter:['has','point_count'],
          paint:{ 'circle-radius':['interpolate',['linear'],['get','point_count'],10,12,100,20,1000,30], 'circle-color':'#1d4ed8' },
          layout:{ visibility:'none' } });
        map.addLayer({ id:'cluster-count', type:'symbol', source:'poi', filter:['has','point_count'],
          layout:{ 'text-field':['get','point_count_abbreviated'], 'text-size':12, visibility:'none' } });
        map.addLayer({ id:'points', type:'circle', source:'poi', filter:['!',['has','point_count']],
          paint:{ 'circle-radius':6, 'circle-color':'#10b981', 'circle-stroke-color':'#034', 'circle-stroke-width':1 },
          layout:{ visibility:'none' } });

        // Heatmap
        map.addSource('poiNC',{ type:'geojson', data:gj });
        map.addLayer({ id:'heat', type:'heatmap', source:'poiNC', paint:{
          'heatmap-radius':['interpolate',['linear'],['zoom'],10,10,15,25],
          'heatmap-intensity':1.0, 'heatmap-opacity':0.85
        }, layout:{ visibility:'none' }});

        map.addSource('sel',{ type:'geojson', data:{ type:'FeatureCollection', features:[] } });
        map.addLayer({ id:'sel-glow', type:'circle', source:'sel', paint:{ 'circle-radius':14, 'circle-color':'rgba(59,130,246,0.25)' } });
        map.addLayer({ id:'sel-ring', type:'circle', source:'sel', paint:{ 'circle-radius':8, 'circle-color':'#fff', 'circle-stroke-color':'#1d4ed8', 'circle-stroke-width':2 } });

        map.on('click','clusters',(e)=>{
          const f=map.queryRenderedFeatures(e.point,{layers:['clusters']});
          const clusterId=f[0].properties.cluster_id;
          map.getSource('poi').getClusterExpansionZoom(clusterId,(err,zoom)=>{ if(err) return; map.easeTo({ center:f[0].geometry.coordinates, zoom }); });
        });
        map.on('click','points',(e)=>{
          const f=e.features && e.features[0]; if(!f) return;
          f.properties = normalizePropsGeneric(f.properties||{});
          const c=f.geometry.coordinates.slice(); setSelectedFeature(c, f.properties.__N);
        });
        map.on('click','individual-points',(e)=>{
          const f=e.features && e.features[0]; if(!f) return;
          f.properties = normalizePropsGeneric(f.properties||{});
          const c=f.geometry.coordinates.slice(); setSelectedFeature(c, f.properties.__N);
        });
        map.on('mouseenter','points',()=> map.getCanvas().style.cursor='pointer');
        map.on('mouseleave','points',()=> map.getCanvas().style.cursor='');
        map.on('mouseenter','individual-points',()=> map.getCanvas().style.cursor='pointer');
        map.on('mouseleave','individual-points',()=> map.getCanvas().style.cursor='');
      } else {
        map.getSource('poi').setData(gj);
        map.getSource('poiPoints').setData(gj);
        map.getSource('poiNC').setData(gj);
      }
      toggleVisualization();
    }catch(e){
      console.error('ensureLayersAndSetData error:', e);
      statusEl.textContent='Error al preparar capas (ver consola).';
    }
  }

  function toggleVisualization(){
    if(window.__MODE!=='geojson') {
      ['heat','points','clusters','cluster-count','individual-points'].forEach(id=>{ 
        if(map.getLayer(id)) map.setLayoutProperty(id, 'visibility', 'none'); 
      });
      return;
    }
    
    const mode = viewMode.value;
    
    // Ocultar todas las capas primero
    ['heat','points','clusters','cluster-count','individual-points'].forEach(id=>{ 
      if(map.getLayer(id)) map.setLayoutProperty(id, 'visibility', 'none'); 
    });
    
    // Mostrar solo las capas del modo seleccionado
    if (mode === 'heat') {
      if(map.getLayer('heat')) map.setLayoutProperty('heat','visibility','visible');
    } else if (mode === 'clusters') {
      if(map.getLayer('clusters')) map.setLayoutProperty('clusters','visibility','visible');
      if(map.getLayer('cluster-count')) map.setLayoutProperty('cluster-count','visibility','visible');
      if(map.getLayer('points')) map.setLayoutProperty('points','visibility','visible');
    } else if (mode === 'points') {
      if(map.getLayer('individual-points')) map.setLayoutProperty('individual-points','visibility','visible');
    }
  }
  viewMode.onchange = toggleVisualization;

  // ===== Capas PMTiles (vector tiles)
  function ensurePMTilesLayers(url, sourceLayer){
    // Oculta capas GeoJSON
    ['heat','points','clusters','cluster-count','individual-points'].forEach(id=>{ 
      if(map.getLayer(id)) map.setLayoutProperty(id,'visibility','none'); 
    });

    if(!map.getSource('vt')){
      map.addSource('vt',{ type:'vector', url:'pmtiles://'+url });
      map.addLayer({ id:'vt-points', type:'circle', source:'vt', 'source-layer':sourceLayer,
        paint:{ 'circle-radius':['interpolate',['linear'],['zoom'], 6,1.5, 12,3, 16,6],
                'circle-color':'#2563eb', 'circle-opacity':0.85, 'circle-stroke-color':'#fff', 'circle-stroke-width':0.2 } });
      // marcador de selecci√≥n reutiliza la fuente 'sel'
      if(!map.getSource('sel')) map.addSource('sel',{ type:'geojson', data:{ type:'FeatureCollection', features:[] } });
      if(!map.getLayer('sel-glow')) map.addLayer({ id:'sel-glow', type:'circle', source:'sel', paint:{ 'circle-radius':14, 'circle-color':'rgba(59,130,246,0.25)' } });
      if(!map.getLayer('sel-ring')) map.addLayer({ id:'sel-ring', type:'circle', source:'sel', paint:{ 'circle-radius':8, 'circle-color':'#fff', 'circle-stroke-color':'#1d4ed8', 'circle-stroke-width':2 } });

      // Click en vector tiles (usa props si existen)
      map.on('click','vt-points',(e)=>{
        const f=e.features && e.features[0]; if(!f) return;
        const n = {
          Nombre: f.properties?.Nombre || f.properties?.nombre || '',
          Clase:  f.properties?.Clase  || f.properties?.clase  || '',
          TipoV:  f.properties?.TipoV  || f.properties?.Tipo_vialidad || '',
          Calle:  f.properties?.Calle  || '',
          NumExt: f.properties?.NumExt || f.properties?.Num_Exterior || '',
          NumInt: f.properties?.NumInt || f.properties?.Num_Interior || '',
          Colonia:f.properties?.Colonia|| '',
          CP:     f.properties?.CP     || '',
          Ubic:   f.properties?.Ubic   || f.properties?.Ubicacion || '',
          Tel:    f.properties?.Tel    || f.properties?.Telefono || '',
          Web:    f.properties?.Web    || f.properties?.Sitio_internet || '',
          CLEE:   f.properties?.CLEE   || '',
          Id:     f.properties?.Id     || ''
        };
        setSelectedFeature(f.geometry.coordinates.slice(), n);
      });
      map.on('mouseenter','vt-points',()=> map.getCanvas().style.cursor='pointer');
      map.on('mouseleave','vt-points',()=> map.getCanvas().style.cursor='');
    } else {
      map.getSource('vt').setUrl('pmtiles://'+url);
      // actualizar 'source-layer' si cambi√≥
      if (map.getLayer('vt-points')) {
        map.removeLayer('vt-points');
        map.addLayer({ id:'vt-points', type:'circle', source:'vt', 'source-layer':sourceLayer,
          paint:{ 'circle-radius':['interpolate',['linear'],['zoom'], 6,1.5, 12,3, 16,6],
                  'circle-color':'#2563eb', 'circle-opacity':0.85, 'circle-stroke-color':'#fff', 'circle-stroke-width':0.2 } });
      }
    }
  }

  // ===== Filtros espaciales para PMTiles
  function applyPMTilesRegionFilter() {
    if (!window.__region || !map.getLayer('vt-points')) return;
    
    // Convertir pol√≠gono a filtro de MapLibre GL
    const coords = window.__region.coordinates[0];
    
    // Crear bbox del pol√≠gono para filtro aproximado
    const lngs = coords.map(c => c[0]);
    const lats = coords.map(c => c[1]);
    const bbox = [
      Math.min(...lngs), // west
      Math.min(...lats), // south  
      Math.max(...lngs), // east
      Math.max(...lats)  // north
    ];
    
    // Aplicar filtro de bbox a la capa PMTiles
    // Nota: esto es una aproximaci√≥n, no un filtro de pol√≠gono exacto
    const filter = [
      'all',
      ['>=', ['get', 'Longitud'], bbox[0]],
      ['<=', ['get', 'Longitud'], bbox[2]], 
      ['>=', ['get', 'Latitud'], bbox[1]],
      ['<=', ['get', 'Latitud'], bbox[3]]
    ];
    
    try {
      map.setFilter('vt-points', filter);
    } catch(e) {
      // Si las propiedades no existen, usar filtro geom√©trico b√°sico
      console.warn('No se pudo aplicar filtro por propiedades, usando aproximaci√≥n visual');
    }
  }
  
  function clearPMTilesRegionFilter() {
    if (map.getLayer('vt-points')) {
      map.setFilter('vt-points', null);
    }
  }

  // ===== Detalle y highlight
  function setSelectedFeature(coord, N){
    const sel={ type:'FeatureCollection', features:[{ type:'Feature', geometry:{ type:'Point', coordinates:coord }, properties:{} }] };
    map.getSource('sel').setData(sel);
    renderInfo(N, coord);
  }
  function clearInfo(){
    if(map.getSource('sel')) map.getSource('sel').setData({ type:'FeatureCollection', features:[] });
    detail.innerHTML='<div class="muted">Selecciona un punto.</div>';
  }
  function renderInfo(n, coord){
    const dir=[n.TipoV,n.Calle,n.NumExt].filter(Boolean).join(' ')+(n.NumInt?` Int ${n.NumInt}`:'');
    const colcp=[n.Colonia,n.CP].filter(Boolean).join(', ');
    const ids=[n.CLEE?`CLEE: ${esc(n.CLEE)}`:'', n.Id?`ID: ${esc(n.Id)}`:''].filter(Boolean).join(' ¬∑ ');
    const mapsLink=`https://www.google.com/maps/search/?api=1&query=${encodeURIComponent(coord[1]+','+coord[0])}`;
    detail.innerHTML=`
      <div class="title">${esc(n.Nombre||'(sin nombre)')}</div>
      ${n.Clase?`<div class="tag">${esc(n.Clase)}</div>`:''}
      ${dir.trim()?`<div>${esc(dir)}</div>`:''}
      ${colcp?`<div>${esc(colcp)}</div>`:''}
      ${n.Ubic?`<div class="muted">${esc(n.Ubic)}</div>`:''}
      <div class="rowline">
        ${n.Tel?`<span>üìû ${esc(n.Tel)}</span>`:''}
        ${n.Web?`<a class="btnLink" href="${safeUrl(n.Web)}" target="_blank" rel="noopener">üåê sitio</a>`:''}
        <a class="btnLink" href="${mapsLink}" target="_blank" rel="noopener">üó∫Ô∏è Maps</a>
      </div>
      ${ids?`<div class="mono">${ids}</div>`:''}
      <div class="rowline" style="margin-top:6px">
        <input id="aliasInp" placeholder="Alias (ej. 'Abarrotes Don Pepe - norte')" style="flex:1">
        <button id="saveAlias" class="secondary">‚≠ê Guardar</button>
        <button id="copyBtn" class="ghost">üìã Copiar</button>
      </div>`;
    document.getElementById('copyBtn').onclick=()=> navigator.clipboard?.writeText(JSON.stringify({ ...n, lat:coord[1], lon:coord[0] },null,2));
    document.getElementById('saveAlias').onclick=()=>{
      const alias=document.getElementById('aliasInp').value.trim() || n.Nombre || '(sin nombre)';
      const entry={ id:`${coord[0]}|${coord[1]}|${n.CLEE||''}|${n.Id||''}`, alias,
        nombre:n.Nombre, clase:n.Clase, lat:coord[1], lon:coord[0], __N:n };
      const arr=readSaved(); const i=arr.findIndex(x=>x.id===entry.id); if(i>=0) arr[i]=entry; else arr.push(entry); writeSaved(arr);
    };
  }

  // ===== Utils
  function downloadJSON(obj, filename){
    const blob=new Blob([JSON.stringify(obj,null,2)],{type:'application/json'});
    const url=URL.createObjectURL(blob); const a=Object.assign(document.createElement('a'),{href:url,download:filename});
    document.body.appendChild(a); a.click(); a.remove(); URL.revokeObjectURL(url);
  }
  function downloadCSV(gj, filename){
    const rows=(gj.features||[]).map(f=>{
      const n=f.properties?.__N||{};
      return [
        csv(n.Nombre), csv(n.Clase), csv(n.TipoV), csv(n.Calle), csv(n.NumExt), csv(n.NumInt),
        csv(n.Colonia), csv(n.CP), csv(n.Ubic), csv(n.Tel), csv(n.Web), csv(n.CLEE), csv(n.Id),
        f.geometry.coordinates[1], f.geometry.coordinates[0]
      ].join(',');
    });
    const head='Nombre,Clase,TipoV,Calle,NumExt,NumInt,Colonia,CP,Ubic,Tel,Web,CLEE,Id,Lat,Lon\n';
    const blob=new Blob([head+rows.join('\n')],{type:'text/csv;charset=utf-8;'});
    const url=URL.createObjectURL(blob); const a=Object.assign(document.createElement('a'),{href:url,download:filename});
    document.body.appendChild(a); a.click(); a.remove(); URL.revokeObjectURL(url);
  }
  function csv(v){ v=v==null?'':String(v); if(/[",\n]/.test(v)) return `"${v.replace(/"/g,'""')}"`; return v; }
  function esc(s){ return String(s).replace(/[&<>"']/g,c=>({'&':'&amp;','<':'&lt;','>':'&gt;','"':'&quot;',"'":'&#39;'}[c])); }
  function safeUrl(u){ try{ return new URL(u).href; }catch{ return '#'; } }

  // ===== Normalizaci√≥n + stats
  function normalizeAnyToGeoJSON(any){
    if(!any) return null;
    if(any.type==='FeatureCollection' && Array.isArray(any.features)){
      for(const f of any.features){ f.properties=normalizePropsGeneric(f.properties||{}); }
      return any;
    }
    if(Array.isArray(any) && any[0] && any[0].type==='Feature'){
      for(const f of any){ f.properties=normalizePropsGeneric(f.properties||{}); }
      return { type:'FeatureCollection', features:any };
    }
    if(Array.isArray(any)){
      const features=[];
      for(const r of any){
        const ll=getLonLat(r); if(!ll) continue;
        const props=Array.isArray(r)?mapArrayRowToProps(r):{...r};
        features.push({ type:'Feature', geometry:{ type:'Point', coordinates:[ll.lon,ll.lat] }, properties: normalizePropsGeneric(props) });
      }
      return { type:'FeatureCollection', features };
    }
    return null;
  }
  function getLonLat(obj){
    const lon=Number(obj.Longitud??obj.longitud??obj.lon??obj.Lon??obj.lng??obj.LNG??(Array.isArray(obj)?obj[17]:NaN));
    const lat=Number(obj.Latitud??obj.latitud??obj.lat??obj.Lat??obj.latitude??obj.Latitude??(Array.isArray(obj)?obj[18]:NaN));
    if(isFinite(lon)&&isFinite(lat)) return {lon,lat}; return null;
  }
  function mapArrayRowToProps(arr){
    const p={}; p.CLEE=arr[0]; p.Id=arr[1]; p.Nombre=arr[2]; p.Razon_social=arr[3];
    p.Clase_actividad=arr[4]; p.Estrato=arr[5]; p.Tipo_vialidad=arr[6]; p.Calle=arr[7];
    p.Num_Exterior=arr[8]; p.Num_Interior=arr[9]; p.Colonia=arr[10]; p.CP=arr[11];
    p.Ubicacion=arr[12]; p.Telefono=arr[13]; p.Correo_e=arr[14]; p.Sitio_internet=arr[15];
    p.Tipo=arr[16]; p.Longitud=arr[17]; p.Latitud=arr[18]; return p;
  }
  function normalizePropsGeneric(p){
    const Nombre=p.__N?.Nombre??p.Nombre??p.nombre??'';
    const Clase =p.__N?.Clase ??p.Clase_actividad??p.clase??p.Clase??p.Subsector_actividad??'';
    const TipoV =p.__N?.TipoV ??p.Tipo_vialidad??'';
    const Calle =p.__N?.Calle ??p.Calle??'';
    const NumExt=p.__N?.NumExt??p.Num_Exterior??'';
    const NumInt=p.__N?.NumInt??p.Num_Interior??'';
    const Colonia=p.__N?.Colonia??p.Colonia??'';
    const CP    =p.__N?.CP    ??p.CP??'';
    const Ubic  =p.__N?.Ubic  ??p.Ubicacion??p.Ubic??'';
    const Tel   =p.__N?.Tel   ??p.Telefono??'';
    const Web   =p.__N?.Web   ??p.Sitio_internet??'';
    const CLEE  =p.__N?.CLEE  ??p.CLEE??p.clee??'';
    const Id    =p.__N?.Id    ??p.Id??p.id??'';
    return { ...p, __N:{Nombre,Clase,TipoV,Calle,NumExt,NumInt,Colonia,CP,Ubic,Tel,Web,CLEE,Id} };
  }
  function buildClassStats(gj){
    const map=new Map();
    for(const f of (gj.features||[])){
      const c=(f.properties?.__N?.Clase||'').trim() || '(sin clase)';
      map.set(c, (map.get(c)||0)+1);
    }
    const list=Array.from(map.entries()).sort((a,b)=>b[1]-a[1]).map(([k,v])=>({k,v}));
    return { list, total: gj.features?.length||0 };
  }
  function populateClassSelect(items, q){
    classSel.innerHTML='';
    const qq=(q||'').toLowerCase();
    for(const it of items){
      if(qq && !it.k.toLowerCase().includes(qq)) continue;
      const opt=document.createElement('option');
      opt.value=it.k; opt.textContent=`${it.k} ‚Äî ${it.v.toLocaleString()}`;
      classSel.appendChild(opt);
    }
  }

  // ===== Fit bounds
  function fitToData(gj){
    const pts=(gj.features||[]).filter(f=>f.geometry?.type==='Point');
    if(!pts.length) return;
    const xs=pts.map(f=>f.geometry.coordinates[0]), ys=pts.map(f=>f.geometry.coordinates[1]);
    const minX=Math.min(...xs), maxX=Math.max(...xs), minY=Math.min(...ys), maxY=Math.max(...ys);
    map.fitBounds([[minX,minY],[maxX,maxY]],{ padding:40, maxZoom:15 });
  }

  // ===== Funciones auxiliares faltantes
  function readSaved(){
    try{ return JSON.parse(localStorage.getItem('saved_pois')||'[]'); }catch{ return []; }
  }
  function writeSaved(arr){
    localStorage.setItem('saved_pois', JSON.stringify(arr)); 
    updateSavedList();
  }
  function updateSavedList(){
    const arr=readSaved();
    savedList.innerHTML=arr.map(it=>`
      <div class="item">
        <div><b>${esc(it.alias)}</b><br><span class="muted">${esc(it.clase||'')}</span></div>
        <div style="display:flex;gap:4px">
          <button class="btnGray" onclick="goToSaved('${it.id}')">üìç</button>
          <button class="btnGray" onclick="deleteSaved('${it.id}')">üóëÔ∏è</button>
        </div>
      </div>
    `).join('');
  }
  function goToSaved(id){
    const arr=readSaved(); const it=arr.find(x=>x.id===id); if(!it) return;
    map.easeTo({ center:[it.lon??it.__N?.Lon??0, it.lat??it.__N?.Lat??0], zoom:16 });
  }
  function deleteSaved(id){
    const arr=readSaved(); writeSaved(arr.filter(x=>x.id!==id));
  }
  
  async function waitForPMTiles(timeout=10000){
    const start=Date.now();
    while(!window.__pmtilesReady && Date.now()-start<timeout) await new Promise(r=>setTimeout(r,100));
    return !!window.__pmtilesReady;
  }

  // Eventos de guardados
  exportSavedBtn.onclick=()=>{ const arr=readSaved(); if(!arr.length) return; downloadJSON(arr, 'guardados.json'); };
  clearSavedBtn.onclick=()=>{ if(confirm('¬øBorrar todos los guardados?')) writeSaved([]); };
  importSavedInp.onchange=()=>{
    const file=importSavedInp.files[0]; if(!file) return;
    const reader=new FileReader();
    reader.onload=()=>{ try{ const arr=JSON.parse(reader.result); writeSaved(arr); }catch{ alert('Archivo inv√°lido'); } };
    reader.readAsText(file);
  };
  
  // Init guardados
  updateSavedList();

  // Init
  map.on('load', async ()=>{
    await listFiles();
    // Autoload del seleccionado
    if(filesSel.options.length && !filesSel.options[0].textContent.includes('(no hay')) {
      // Si es PMTiles, espera lib y carga
      const isPM = filesSel.value?.toLowerCase().endsWith('.pmtiles');
      if (isPM) await waitForPMTiles(10000);
      loadSelected();
    }
  });
  })();
</script>
</body>
</html>
